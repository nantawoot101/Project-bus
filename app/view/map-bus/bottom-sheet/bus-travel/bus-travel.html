<div>
  <link
    rel="stylesheet"
    href="app/view/map-bus/bottom-sheet/bus-travel/bus-travel.css"
  />

  <md-bottom-sheet
    class="custom-bottom-sheet"
    id="bottomSheet"
    ng-if="currentStep === 1"
    ng-class="{ expanded: isExpanded }"
    ng-style="{ overflowY: isExpanded ? 'auto' : 'hidden' }"
  >
    <div
      class="drag-handle"
      ng-mousedown="startDrag($event)"
      ontouchstart="startDrag(event)"
    ></div>
    <div class="font-SL m-l-12 m-t-10">เส้นทางทั้งหมด</div>

    <md-list-item
      ng-repeat="route in transportation_routes"
      ng-click="goToStep(2, route)"
    >
      <div class="station-flex">
        <div class="station-box-container">
          <div class="station-box" ng-class="getBorderClass(route.route_name)">
            {{ route.route_name }}
          </div>
          <img class="arrow-right" src="app/assets/icon/arrow-right.svg" />
        </div>

        <div class="station-arrow-destination">
          <div class="destination-info">
            <div class="font-gray">ปลายทาง</div>
            <div class="font-SL">
              {{ getStationName(route.destination_station_id) }}
            </div>
          </div>
        </div>
      </div>
    </md-list-item>
  </md-bottom-sheet>

  <md-bottom-sheet
    class="custom-bottom-sheet"
    id="bottomSheet"
    ng-if="currentStep === 2 "
    ng-class="{ expanded: isExpanded }"
    ng-style="{ overflowY: isExpanded ? 'auto' : 'hidden' }"
  >
    <div
      class="drag-handle"
      ng-mousedown="startDrag($event)"
      ontouchstart="startDrag(event)"
    ></div>

    <button class="close-btn-tab" ng-click="goBackToStep1()" aria-label="ปิด">
      &times;
    </button>

    <div class="vertical-connector-container" style="position: relative">
      <div class="mt-20">
        <div
          class="station-box station-display"
          ng-class="getBorderClass(selectedRoute.route_name)"
        >
          <img
            ng-if="selectedRoute.route_name === 'EXPRESS'"
            src="app/assets/icon/bus-simple.svg"
            class="bus-img"
            alt="bus"
          />
          {{ selectedRoute.route_name }}
        </div>

        <div
          ng-repeat="stop in selectedRoute.stops"
          class="station-stop mt-20"
          style="position: relative"
        >
          <div class="column-left">
            <!-- กรณีมี busNumber มากกว่า 1 -->
            <div
              class="bus-wrapper"
              ng-class="getBusClass(selectedRoute.route_name)"
              ng-if="stop.passing_bus_numbers.length > 1"
              ng-click="toggleBusTab(stop.station_id)"
              style="cursor: pointer"
            >
              <span
                class="bus-number-in-rect"
                ng-repeat="busNumber in stop.passing_bus_numbers"
              >
                {{ busNumber }}
              </span>
              <img
                src="app/assets/icon/bus-simple.svg"
                class="bus-img"
                alt="bus"
              />
            </div>

            <!-- กรณีมี busNumber เดียว -->
            <div
              class="bus-wrapper"
              ng-class="getBusClass(selectedRoute.route_name)"
              ng-if="stop.passing_bus_numbers.length === 1"
              ng-click="goToStep(3, selectedRoute, stop.passing_bus_numbers[0])"
              style="cursor: pointer"
            >
              <span class="bus-number-in-rect">
                {{ stop.passing_bus_numbers[0] }}
              </span>
              <img
                src="app/assets/icon/bus-simple.svg"
                class="bus-img"
                alt="bus"
              />
            </div>

            <!-- กรณีแสดงเมนูป็อปอัพด้านล่าง -->
            <div
              ng-if="busTabOpen === stop.station_id"
              class="bus-select-tab-container mt-2"
            >
              <select
                ng-model="selectedBusNumber[stop.station_id]"
                ng-options="bus for bus in stop.passing_bus_numbers"
                ng-change="goToStep(3, selectedRoute, selectedBusNumber[stop.station_id])"
                class="form-control"
                style="
                  width: 100%;
                  padding: 6px;
                  border-radius: 4px;
                  border: 1px solid #ccc;
                "
              >
                <option value="" disabled selected>เลือกรถเมล์</option>
              </select>
            </div>
          </div>

          <div class="column-right">
            <div class="station-number-column">
              <div
                class="number-circle"
                ng-class="getBorderStation(selectedRoute.route_name)"
                style="z-index: 2; position: relative"
              >
                {{ $index + 1 }}

                <div
                  ng-if="!$last"
                  class="vertical-connector"
                  ng-class="[
    getVerticalClass(selectedRoute.route_name),
    stop.buses_in_transit_to_next_stop.length > 0 ? 'has-bus-in-transit' : ''
  ]"
                >
                  <div
                    class="bus-in-transit-dot"
                    ng-if="stop.buses_in_transit_to_next_stop.length > 0"
                     ng-class="getDotColorClass(selectedRoute.route_name)"
                  >

                    <!-- แสดง buses_in_transit_to_next_stop กึ่งกลางเส้น -->
                    <div class="station-stop" style="position: relative">
                      <div
                        class="column-left"
                        ng-if="stop.buses_in_transit_to_next_stop && stop.buses_in_transit_to_next_stop.length > 0"
                      >
                        <!-- วางใน .column-left -->
                        <div
                          class="bus-in-transit-floating"
                          ng-if="!$last && stop.buses_in_transit_to_next_stop.length > 0"
                          
                        >
                          <div
                            class="bus-wrapper"
                            ng-class="getBusClass(selectedRoute.route_name)"
                            ng-if="stop.buses_in_transit_to_next_stop.length > 1"
                          >
                            <span
                              class="bus-number-in-rect"
                              ng-repeat="busNumber in stop.buses_in_transit_to_next_stop"
                            >
                              {{ busNumber }}
                            </span>
                            <img
                              src="app/assets/icon/bus-simple.svg"
                              class="bus-img"
                              alt="bus"
                            />
                          </div>

                          <div
                            class="bus-wrapper"
                            ng-class="getBusClass(selectedRoute.route_name)"
                            ng-if="stop.buses_in_transit_to_next_stop.length === 1"
                            ng-click="goToStep(3, selectedRoute, stop.buses_in_transit_to_next_stop[0])"
                            style="cursor: pointer"
                          >
                            <span class="bus-number-in-rect">
                              {{ stop.buses_in_transit_to_next_stop[0] }}
                            </span>
                            <img
                              src="app/assets/icon/bus-simple.svg"
                              class="bus-img"
                              alt="bus"
                            />
                          </div>
                        </div>

                        <!-- กรณีแสดงเมนูป็อปอัพด้านล่าง -->
                        <div
                          ng-if="busTabOpen === stop.station_id"
                          class="bus-select-tab-container mt-2"
                        >
                          <select
                            ng-model="selectedBusNumber[stop.station_id]"
                            ng-options="bus for bus in stop.buses_in_transit_to_next_stop"
                            ng-change="goToStep(3, selectedRoute, selectedBusNumber[stop.station_id])"
                            class="form-control"
                            style="
                              width: 100%;
                              padding: 6px;
                              border-radius: 4px;
                              border: 1px solid #ccc;
                            "
                          >
                            <option value="" disabled selected>
                              เลือกรถเมล์
                            </option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-1 station-name-aligned">
              {{ getStationName(stop.station_id) }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </md-bottom-sheet>

  <md-bottom-sheet
    class="custom-bottom-sheet"
    id="bottomSheet"
    ng-if="currentStep === 3 "
    ng-class="{ expanded: isExpanded }"
    ng-style="{ overflowY: isExpanded ? 'auto' : 'hidden' }"
  >
    <div
      class="drag-handle"
      ng-mousedown="startDrag($event)"
      ontouchstart="startDrag(event)"
    ></div>

    <button class="close-btn-tab" ng-click="goBackToStep2()" aria-label="ปิด">
      &times;
    </button>

    <div class="vertical-connector-container" style="position: relative">
      <div class="mt-20">
        <div class="font-xl mt-2">เส้นทางการเดินรถ</div>

        <div
          ng-repeat="stop in selectedRoute.stops"
          class="station-stop mt-20"
          style="position: relative"
        >
          <div class="column-left">
            <div
              class="bus-wrapper"
              ng-class="getBusClass(selectedRoute.route_name)"
              ng-if="stop.passing_bus_numbers.indexOf(selectedBusNumber) !== -1"
            >
              <span class="bus-number-in-rect"> {{ selectedBusNumber }} </span>
              <img
                src="app/assets/icon/bus-simple.svg"
                class="bus-img"
                alt="bus"
              />
            </div>
          </div>

          <div class="column-right">
            <div class="station-number-column">
              <div
                class="number-circle"
                ng-class="getBorderStep3_Station(selectedRoute, stop)"
                style="z-index: 2; position: relative"
              >
                {{ $index + 1 }}

                <div
                  ng-if="!$last"
                  class="vertical-connector"
                  ng-class="getConnectorClass(selectedRoute, $index)"
                >
                 <div
                    class="bus-in-transit-dot"
                    ng-if="stop.buses_in_transit_to_next_stop.length > 0"
                     ng-class="getDotColorClass(selectedRoute.route_name)"
                  >
                  <div class="column-left">
                    <div class="bus-in-transit-floating">
                      <div
                        class="bus-wrapper"
                        ng-class="getBusClass(selectedRoute.route_name)"
                        ng-if="stop.buses_in_transit_to_next_stop.indexOf(selectedBusNumber) !== -1"
                      >
                        <span class="bus-number-in-rect">
                          {{ selectedBusNumber }}
                        </span>
                        <img
                          src="app/assets/icon/bus-simple.svg"
                          class="bus-img"
                          alt="bus"
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              </div>
            </div>

            <div class="mt-1 station-name-aligned">
              {{ getStationName(stop.station_id) }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </md-bottom-sheet>
</div>
